{# Load crispy-forms helpers plus access to static assets. #}
{% load crispy_forms_tags %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Title used in the browser tab. -->
    <title>Expenses Dashboard</title>
    <!-- Bootstrap CSS for responsive layout/widgets. -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom styles for Ledgerly UI. -->
    <link rel="stylesheet" href="{% static 'expenses/style.css' %}">
</head>
{% if user.is_authenticated %}
    <!-- Primary dashboard shown only to authenticated users. -->

<body>
    <nav class="navbar navbar-light bg-light">
        <div class="container">
            {% if user.is_authenticated %}
                <a class="navbar-brand mb-0 h1" href="{% url 'dashboard' %}">Ledgerly</a>
            {% else %}
                <span class="navbar-brand mb-0 h1">Ledgerly</span>
            {% endif %}
            {% if user.is_authenticated %}
                <div class="d-flex align-items-center">
                    <!-- Friendly greeting showing who is signed in. -->
                    <span class="navbar-text me-3">Welcome, {{ user.username }}!</span>
                    <div class="dropdown">
                        <!-- Account dropdown exposes profile management links. -->
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false">
                            Account
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="userMenu">
                            <!-- Shortcuts to allauth-managed account settings. -->
                            <li><a class="dropdown-item" href="{% url 'account_change_password' %}">Change Password</a></li>
                            <li><a class="dropdown-item" href="{% url 'account_email' %}">Email Settings</a></li>
                            <!-- Allow users to self-service delete their account. -->
                            <li><a class="dropdown-item text-danger" href="{% url 'account_delete' %}">Delete Account</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <!-- Logout hits the custom view that redirects to login. -->
                            <li><a class="dropdown-item" href="{% url 'account_logout' %}">Logout</a></li>
                        </ul>
                    </div>
                </div>
            {% endif %}
        </div>
    </nav>
<div class="container py-4">
    <!-- Mirrored heading to match authentication screens. -->
    <h1 class="mb-4 text-center"><u>Ledgerly</u></h1>
    <div class="row">
        <div class="col-md-6">
            <h2>Add Transaction</h2>
            <!-- Submission form for recording new transactions. -->
            <form method="post" class="mb-4">
                {% csrf_token %}
                <div class="mb-3">
                    <!-- Choose income vs outgoing. -->
                    <label class="form-label">Type</label>
                    <select name="type" class="form-select">
                        <option value="INCOME">Income</option>
                        <option value="OUTGO">Outgoing</option>
                    </select>
                </div>
                <div class="mb-3">
                    <!-- Monetary amount stored in cents server-side. -->
                    <label class="form-label">Amount</label>
                    <input type="number" name="amount_in_cents" class="form-control" required>
                </div>
                <div class="mb-3">
                    <!-- Category dropdown populated from the view context. -->
                    <label class="form-label">Category</label>
                    <select name="category" class="form-select">
                        {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <!-- Date picker defaults to HTML5 date input. -->
                    <label class="form-label">Date</label>
                    <input type="date" name="occurred_on" class="form-control" required>
                </div>
                <div class="mb-3">
                    <!-- Optional annotation for the transaction. -->
                    <label class="form-label">Note</label>
                    <input type="text" name="note" class="form-control">
                </div>
                <!-- Submit button posts back to the same dashboard view. -->
                <button type="submit" class="btn btn-primary">Add</button>
            </form>
        </div>
        <div class="col-md-6">
            <h2>Monthly Summary</h2>
            <!-- Aggregated totals calculated in the dashboard view. -->
            <ul class="list-group mb-4">
                <li class="list-group-item">Income: {{ income }}</li>
                <li class="list-group-item">Outgoings: {{ outgo }}</li>
                <li class="list-group-item">Balance: {{ balance }}</li>
                {% if top_spend %}
                    <!-- Highlight the largest outgoing for context. -->
                    <li class="list-group-item">Most expensive spend: {{ top_spend.amount_in_cents }} ({{ top_spend.category }})</li>
                {% endif %}
            </ul>
            <h2>Recent Transactions</h2>
            <!-- Latest entries limited in the view to keep list concise. -->
            <ul class="list-group">
                {% for t in transactions %}
                    <li class="list-group-item">
                        {{ t.occurred_on }}: {{ t.type }} - {{ t.amount_in_cents }} ({{ t.category }}) {{ t.note }}
                    </li>
                {% empty %}
                    <!-- Fallback when a user has not logged any data yet. -->
                    <li class="list-group-item">No transactions yet.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
<!-- Bootstrap bundle provides interactive behaviour (dropdowns, etc.). -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
{% else %}
    <!-- For anonymous users, bounce them straight to the login screen. -->
    <script>
        window.location.href = "{% url 'account_login' %}";
    </script>
{% endif %}